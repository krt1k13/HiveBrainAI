<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Hive Chat // OS Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Space+Mono&display=swap');
        
        :root {
            --bg: #000000;
            --surface: #0a0a0a;
            --accent: #ffffff;
            --border: rgba(255, 255, 255, 0.1);
            --red: #ff3b3b;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--accent);
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            letter-spacing: -0.01em;
            position: relative;
        }

        .mono { font-family: 'Space Mono', monospace; }

        .glass {
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--border);
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 2rem 1rem;
            scroll-behavior: smooth;
            background: radial-gradient(circle at center, #0a0a0a 0%, #000 100%);
        }

        .message {
            margin-bottom: 2rem;
            display: flex;
            flex-direction: column;
            animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .user-message { align-items: flex-end; }
        .ai-message { align-items: flex-start; }

        .bubble {
            max-width: 85%;
            padding: 1.25rem;
            font-size: 0.9rem;
            line-height: 1.6;
            border-radius: 2px;
        }

        .user-bubble {
            background: var(--accent);
            color: var(--bg);
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.05em;
        }

        .ai-bubble {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            position: relative;
        }

        .ai-bubble::before {
            content: "HIVE_OUT";
            position: absolute;
            top: -10px;
            left: 10px;
            background: #000;
            padding: 0 5px;
            font-family: 'Space Mono';
            font-size: 8px;
            color: #444;
            letter-spacing: 1px;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        .checkbox-container input { display: none; }
        .checkmark {
            width: 12px;
            height: 12px;
            border: 1px solid #333;
            margin-right: 8px;
            display: inline-block;
            position: relative;
            transition: all 0.2s;
        }
        .checkbox-container input:checked + .checkmark {
            background: white;
            border-color: white;
        }
        .checkbox-container input:checked + .checkmark::after {
            content: '';
            position: absolute;
            left: 3px;
            top: 0px;
            width: 4px;
            height: 8px;
            border: solid black;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .chat-container::-webkit-scrollbar { width: 0; }
        
        .loading-dots:after {
            content: '.';
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }

        .action-btn {
            font-size: 7px;
            letter-spacing: 1px;
            padding: 4px 8px;
            border: 1px solid rgba(255,255,255,0.05);
            transition: all 0.2s;
        }
        .action-btn:hover {
            border-color: white;
            background: rgba(255,255,255,0.05);
        }
        .action-btn.red:hover {
            border-color: var(--red);
            color: var(--red);
        }
    </style>
</head>
<body>
    <div class="scanlines"></div>

    <nav class="h-16 flex items-center justify-between px-6 border-b border-[#1a1a1a] bg-black sticky top-0 z-50">
        <div class="flex items-center gap-4">
            <div id="status-dot" class="w-2 h-2 bg-red-600 rounded-full transition-colors duration-500"></div>
            <div>
                <h1 class="text-[10px] mono font-bold tracking-[0.3em] uppercase">Hive Chat // OS</h1>
                <p id="memory-info" class="text-[8px] mono text-zinc-600 uppercase">System Initializing...</p>
            </div>
        </div>
        <div class="flex gap-4">
            <label class="checkbox-container">
                <input type="checkbox" id="search-permission">
                <span class="checkmark"></span>
                <span class="text-[8px] mono uppercase opacity-60">Search Archive</span>
            </label>
            <span id="connection-status" class="text-[8px] mono uppercase opacity-40 self-center">Offline</span>
        </div>
    </nav>

    <main id="chat-window" class="chat-container">
        <div class="message ai-message">
            <div class="bubble ai-bubble" id="welcome-bubble">
                Collective node active. High-trust memories are prioritized. Reported nodes are pruned automatically.
            </div>
        </div>
    </main>

    <footer class="p-6 bg-black border-t border-[#1a1a1a]">
        <div class="max-w-4xl mx-auto">
            <form id="chat-form" class="relative group">
                <div class="absolute -left-2 top-1/2 -translate-y-1/2 w-0.5 h-6 bg-zinc-800 group-focus-within:bg-white transition-all"></div>
                <input type="text" id="user-input" placeholder="Awaiting authentication..." 
                    class="w-full bg-[#050505] border border-[#1a1a1a] px-6 py-5 text-xs mono uppercase focus:outline-none focus:border-white transition-all" disabled>
                <button type="submit" id="send-btn" disabled 
                    class="absolute right-3 top-1/2 -translate-y-1/2 bg-white text-black px-6 py-2 text-[9px] font-black mono uppercase hover:tracking-widest transition-all disabled:opacity-30">
                    Send
                </button>
            </form>
            <div class="flex justify-between items-center mt-4 opacity-30">
                <span id="user-uid" class="text-[8px] mono uppercase">ID_PENDING</span>
                <span class="text-[8px] mono uppercase tracking-widest">Protocol v4.2 // FAST_COMMIT</span>
            </div>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, increment, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCo7MaoXSGE7BcK-gOLI7xV6l9hSNwP158",
            authDomain: "communityai-2eb16.firebaseapp.com",
            projectId: "communityai-2eb16",
            storageBucket: "communityai-2eb16.firebasestorage.app",
            messagingSenderId: "750106858888",
            appId: "1:750106858888:web:f527a6e73daef349d6163d",
            measurementId: "G-39B2BVQLFY"
        };

        let db, auth, appId;
        let hiveMemory = [];
        let dataLoaded = false;

        const chatWindow = document.getElementById('chat-window');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const memoryInfo = document.getElementById('memory-info');
        const uidDisplay = document.getElementById('user-uid');
        const statusDot = document.getElementById('status-dot');
        const connStatusText = document.getElementById('connection-status');
        const searchPermission = document.getElementById('search-permission');

        async function fetchWikipedia(subject) {
            try {
                const endpoint = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(subject)}`;
                const response = await fetch(endpoint);
                if (!response.ok) return null;
                const data = await response.json();
                return data.extract || null;
            } catch (e) { return null; }
        }

        async function initApp() {
            try {
                appId = typeof __app_id !== 'undefined' ? __app_id : 'hive-node-v1';
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        uidDisplay.innerText = `ID_${user.uid}`;
                        statusDot.classList.replace('bg-red-600', 'bg-white');
                        statusDot.classList.add('animate-pulse');
                        connStatusText.innerText = "Online";
                        userInput.disabled = false;
                        sendBtn.disabled = false;
                        userInput.placeholder = "Query collective memory...";
                        if (!dataLoaded) { initSync(); dataLoaded = true; }
                    }
                });
                await signInAnonymously(auth);
            } catch (err) {
                console.error("Init Error:", err);
                memoryInfo.innerText = "AUTH_LOCKED";
                if (err.code === 'auth/configuration-not-found') {
                    document.getElementById('welcome-bubble').innerHTML = `<span class="text-red-500 font-bold">CRITICAL_ERROR:</span> Anonymous Authentication is disabled. Enable it in your <a href="https://console.firebase.google.com/project/${firebaseConfig.projectId}/authentication/providers" target="_blank" class="underline">Firebase Console</a>.`;
                }
            }
        }

        function initSync() {
            const memoryRef = collection(db, 'artifacts', appId, 'public', 'data', 'ai_memory');
            onSnapshot(memoryRef, (snap) => {
                hiveMemory = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                memoryInfo.innerText = `${hiveMemory.length}_NODES_SYNCED`;
            }, (err) => {
                console.error("Sync Error:", err);
                memoryInfo.innerText = "SYNC_LOCKED";
            });
        }

        window.commitLogic = async (trigger, teachId) => {
            if (!auth.currentUser) return;
            const inputEl = document.getElementById(`teach-in-${teachId}`);
            const responseText = inputEl.value.trim();
            if (!responseText) return;

            const container = inputEl.parentElement;
            // Optimistic UI: Don't wait for the network to show success state
            container.innerHTML = `<p class="text-[9px] mono uppercase text-white font-bold animate-pulse">Node_Synced_Success</p>`;

            try {
                // We don't "await" the addDoc here to make the UI feel instant
                addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'ai_memory'), {
                    input_text: trigger.toLowerCase(),
                    response_text: responseText,
                    userId: auth.currentUser.uid,
                    likes: 1, 
                    dislikes: 0,
                    reports: 0,
                    created: serverTimestamp()
                }).catch(e => {
                    console.error("Write failed:", e);
                    container.innerHTML = `<p class="text-[9px] mono uppercase text-red-500">Sync_Failed: Retry Required</p>`;
                });
            } catch (e) { 
                container.innerHTML = `<p class="text-[9px] mono uppercase text-red-500">Write_Denied</p>`; 
            }
        };

        window.vote = async (docId, type, btn) => {
            if (!auth.currentUser) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'ai_memory', docId);
            const parent = btn.parentElement;
            
            try {
                if (type === 'report') {
                    if (confirm("Block and report this content? Nodes with high reports are pruned from the collective.")) {
                        await updateDoc(docRef, { reports: increment(1) });
                        const node = hiveMemory.find(n => n.id === docId);
                        if (node && node.reports >= 2) await deleteDoc(docRef);
                        parent.innerHTML = `<span class="text-[7px] text-red-500 mono">NODE_BLOCKED</span>`;
                    }
                } else {
                    const update = type === 'up' ? { likes: increment(1) } : { dislikes: increment(1) };
                    // Optimistic state
                    btn.classList.add('bg-white', 'text-black');
                    btn.disabled = true;
                    await updateDoc(docRef, update);
                }
            } catch (e) { console.error(e); }
        };

        function appendMessage(text, isAi = false, metadata = null) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${isAi ? 'ai-message' : 'user-message'}`;
            
            let sourceTag = isAi ? (metadata?.source ? `[SOURCE: ${metadata.source}]` : '') : '';
            let html = `<div class="bubble ${isAi ? 'ai-bubble' : 'user-bubble'}">
                ${sourceTag ? `<div class="text-[8px] opacity-40 mb-1 mono">${sourceTag}</div>` : ''}
                ${text}
            </div>`;
            
            if (isAi && metadata?.isNew) {
                const teachId = Math.random().toString(36).substring(7);
                html += `
                    <div class="mt-4 p-5 glass w-full max-w-xs border-dashed border-zinc-800 border">
                        <p class="text-[8px] mono text-zinc-500 mb-3 uppercase font-bold tracking-widest">Logic_Gap Found</p>
                        <textarea id="teach-in-${teachId}" placeholder="Define collective response..." class="w-full bg-transparent border border-zinc-800 p-3 text-[10px] mono mb-3 outline-none focus:border-white h-20 resize-none"></textarea>
                        <button onclick="window.commitLogic('${metadata.trigger.replace(/'/g, "\\'")}', '${teachId}')" class="w-full py-3 bg-white text-black text-[9px] mono font-bold uppercase">Commit_Logic</button>
                    </div>
                `;
            } else if (isAi && metadata?.id) {
                html += `
                    <div class="mt-2 flex gap-2 px-1">
                        <button onclick="window.vote('${metadata.id}', 'up', this)" class="action-btn mono uppercase">TRUST_[${metadata.likes || 0}]</button>
                        <button onclick="window.vote('${metadata.id}', 'down', this)" class="action-btn mono uppercase">DISTRUST_[${metadata.dislikes || 0}]</button>
                        <button onclick="window.vote('${metadata.id}', 'report', this)" class="action-btn red mono uppercase ml-auto">BLOCK_REPORT</button>
                    </div>
                `;
            }

            msgDiv.innerHTML = html;
            chatWindow.appendChild(msgDiv);
            chatWindow.scrollTo({ top: chatWindow.scrollHeight, behavior: 'smooth' });
        }

        function findBestMatch(input) {
            const queryWords = input.toLowerCase().split(/\s+/).filter(w => w.length >= 2);
            let best = null;
            let maxScore = 0;

            hiveMemory.forEach(node => {
                if ((node.reports || 0) > 2) return; 
                const nodeWords = (node.input_text || "").toLowerCase().split(/\s+/).filter(w => w.length >= 2);
                if (queryWords.length === 0 || nodeWords.length === 0) return;
                const matches = queryWords.filter(w => nodeWords.includes(w));
                let matchScore = matches.length / Math.max(queryWords.length, nodeWords.length);
                const trust = (node.likes || 0) - (node.dislikes || 0);
                const trustMultiplier = 1 + (Math.max(Math.min(trust, 10), -5) / 40); 
                const finalScore = matchScore * trustMultiplier;
                if (finalScore > maxScore) {
                    maxScore = finalScore;
                    best = node;
                }
            });
            return { match: best, score: maxScore };
        }

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = userInput.value.trim();
            if (!text || !auth.currentUser) return;
            userInput.value = '';
            appendMessage(text, false);

            const { match, score } = findBestMatch(text);

            if (match && score > 0.35) {
                setTimeout(() => {
                    appendMessage(match.response_text, true, { 
                        isNew: false, id: match.id, likes: match.likes, dislikes: match.dislikes, source: "COLLECTIVE" 
                    });
                }, 100);
            } else if (searchPermission.checked) {
                const wikiResult = await fetchWikipedia(text);
                if (wikiResult) { appendMessage(wikiResult, true, { source: "WIKIPEDIA_ARCHIVE" }); } 
                else { appendMessage(`Logic gap identified for "${text}". Train the collective?`, true, { isNew: true, trigger: text }); }
            } else {
                setTimeout(() => {
                    appendMessage(`Collective logic for "${text}" is not yet indexed. Enable 'Search' or define it.`, true, { isNew: true, trigger: text });
                }, 100);
            }
        });

        window.onload = initApp;
    </script>
</body>
</html>
