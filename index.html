<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>HiveBrainAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Space+Mono&display=swap');
        
        :root {
            --bg: #000000;
            --accent: #ffffff;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            background-image: 
                radial-gradient(circle at 15% 15%, rgba(255,255,255,0.06) 0%, transparent 25%),
                radial-gradient(circle at 85% 85%, rgba(255,255,255,0.04) 0%, transparent 25%);
            color: var(--accent);
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .mono { font-family: 'Space Mono', monospace; }

        .glass-header {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-bottom: 1px solid var(--glass-border);
            z-index: 100;
        }

        .glass-footer {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-top: 1px solid var(--glass-border);
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
            scroll-behavior: smooth;
        }

        .message {
            display: flex;
            flex-direction: column;
            width: 100%;
            animation: expressive-in 0.6s cubic-bezier(0.23, 1, 0.32, 1);
        }

        @keyframes expressive-in {
            from { opacity: 0; transform: translateY(15px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .user-message { align-items: flex-end; }
        .ai-message { align-items: flex-start; }

        .bubble {
            max-width: 85%;
            padding: 1.1rem 1.4rem;
            font-size: 0.95rem;
            line-height: 1.55;
            border-radius: 20px;
            position: relative;
        }

        .user-bubble {
            background: #ffffff;
            color: #000000;
            font-weight: 500;
            border-bottom-right-radius: 4px;
            box-shadow: 0 10px 30px rgba(255,255,255,0.05);
        }

        .ai-bubble {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-bottom-left-radius: 4px;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .spinning { animation: spin 2.5s cubic-bezier(0.4, 0, 0.2, 1) infinite; }

        .logo-img {
            width: 42px;
            height: 42px;
            object-fit: cover;
            border-radius: 12px;
            background: rgba(255,255,255,0.05);
            transition: transform 0.3s ease;
        }

        .meta-container {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            padding: 0 6px;
        }

        .meta-btn {
            font-size: 8px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 6px 12px;
            border-radius: 8px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            white-space: nowrap;
        }

        .meta-btn:hover:not(:disabled) { 
            color: #fff; 
            background: rgba(255, 255, 255, 0.15); 
            border-color: rgba(255, 255, 255, 0.4); 
            transform: translateY(-1px);
        }
        
        .meta-btn:active:not(:disabled) { transform: translateY(0); }
        
        .meta-btn.active-up { background: #10b981 !important; color: #fff !important; border-color: #059669 !important; font-weight: 700; }
        .meta-btn.active-down { background: #ef4444 !important; color: #fff !important; border-color: #dc2626 !important; font-weight: 700; }

        .train-plus {
            width: 28px;
            height: 28px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            margin-left: 10px;
            transition: 0.2s;
            opacity: 0.5;
        }
        .train-plus:hover { opacity: 1; background: #fff; color: #000; transform: scale(1.1); }

        .training-card {
            background: rgba(255,255,255,0.03);
            backdrop-filter: blur(20px);
            border: 1px dashed rgba(255,255,255,0.3);
            border-radius: 20px;
            padding: 1.5rem;
            width: 100%;
            max-width: 450px;
            margin-top: 12px;
        }

        .chat-container::-webkit-scrollbar { width: 4px; }
        .chat-container::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
    </style>
</head>
<body>
    <nav class="h-24 flex items-center justify-between px-8 glass-header sticky top-0">
        <div class="flex items-center gap-5">
            <img id="logo-icon" src="https://formidable-green-gtbdiidfxe.edgeone.app/Untitled%20design.png" 
                 alt="HiveBrain" class="logo-img">
            <h1 class="text-2xl font-bold tracking-tighter">HiveBrainAI</h1>
        </div>
        <div class="flex items-center gap-3 bg-white/5 py-2 px-4 rounded-full border border-white/10">
            <div id="status-dot" class="w-2.5 h-2.5 bg-red-600 rounded-full"></div>
            <span id="conn-text" class="text-[10px] mono uppercase opacity-60 tracking-widest">offline</span>
        </div>
    </nav>

    <main id="chat-window" class="chat-container">
        <div class="message ai-message">
            This AI is trained by the user-generated responses. Some information may be misleading.
            </div>
        </div>
    </main>

    <footer class="p-8 glass-footer">
        <div class="max-w-4xl mx-auto flex flex-col gap-5">
            <div class="flex items-center gap-3 px-2">
                <input type="checkbox" id="search-permission" checked class="w-4 h-4 accent-white cursor-pointer">
                <label for="search-permission" class="text-[10px] mono uppercase opacity-50 cursor-pointer hover:opacity-100 transition-opacity">Hybrid Search Mode</label>
            </div>

            <form id="chat-form" class="relative group">
                <input type="text" id="user-input" placeholder="Ask the Hive..." 
                    spellcheck="true" autocomplete="off"
                    class="w-full bg-white/5 border border-white/10 rounded-3xl px-8 py-6 text-sm focus:outline-none focus:border-white/30 focus:bg-white/10 transition-all shadow-2xl" disabled>
                <button type="submit" id="send-btn" disabled 
                    class="absolute right-4 top-1/2 -translate-y-1/2 bg-white text-black h-12 px-10 rounded-2xl text-[12px] font-black uppercase tracking-widest active:scale-95 transition-all hover:bg-neutral-200">
                    Send
                </button>
            </form>
            <div id="user-uid" class="text-[9px] mono text-center opacity-30 uppercase tracking-[0.5em]">AUTH_SYNC_PENDING</div>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCo7MaoXSGE7BcK-gOLI7xV6l9hSNwP158",
            authDomain: "communityai-2eb16.firebaseapp.com",
            projectId: "communityai-2eb16",
            storageBucket: "communityai-2eb16.firebasestorage.app",
            messagingSenderId: "750106858888",
            appId: "1:750106858888:web:f527a6e73daef349d6163d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'hive-node-v1';
        
        let hiveMemory = [];

        const chatWindow = document.getElementById('chat-window');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const statusDot = document.getElementById('status-dot');
        const connText = document.getElementById('conn-text');
        const logo = document.getElementById('logo-icon');

        async function init() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    statusDot.classList.replace('bg-red-600', 'bg-emerald-500');
                    connText.innerText = "online";
                    userInput.disabled = false;
                    sendBtn.disabled = false;
                    document.getElementById('user-uid').innerText = `NODE_${user.uid.substring(0,10)}`;
                    
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'ai_memory'), (snap) => {
                        hiveMemory = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    });
                }
            });
            await signInAnonymously(auth);
        }

        window.vote = async (docId, type, btn) => {
            if (!docId || docId === 'undefined') return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'ai_memory', docId);
            
            try {
                if (type === 'up') {
                    await updateDoc(docRef, { likes: increment(1) });
                    btn.classList.add('active-up');
                    btn.innerText = `Accepted ✓`;
                } else if (type === 'down') {
                    await updateDoc(docRef, { dislikes: increment(1) });
                    btn.classList.add('active-down');
                    btn.innerText = `Denied ✕`;
                } else if (type === 'report') {
                    await updateDoc(docRef, { reports: increment(1) });
                    btn.innerText = "Reported";
                    btn.style.color = "#f87171";
                }
                
                const container = btn.parentElement;
                container.querySelectorAll('.meta-btn').forEach(b => {
                    b.disabled = true;
                    b.style.pointerEvents = 'none';
                    if (b !== btn) b.style.opacity = "0.3";
                });
            } catch (e) { console.error("Vote error:", e); }
        };

        window.submitTraining = async (trigger, teachId) => {
            const el = document.getElementById(`teach-in-${teachId}`);
            const text = el.value.trim();
            if (!/^[A-Z].*[.!?]$/.test(text)) {
                document.getElementById(`err-${teachId}`).innerText = "Sentence must start with Capital and end with punctuation.";
                return;
            }

            const card = document.getElementById(`card-${teachId}`);
            card.innerHTML = `<div class="py-12 text-center mono text-[11px] animate-pulse">Syncing neural pathway...</div>`;
            logo.classList.add('spinning');

            try {
                const docRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'ai_memory'), {
                    input_text: trigger.toLowerCase().trim(),
                    response_text: text,
                    userId: auth.currentUser.uid,
                    likes: 1, dislikes: 0, reports: 0,
                    created: serverTimestamp()
                });
                
                setTimeout(() => {
                    logo.classList.remove('spinning');
                    card.closest('.message').innerHTML = `
                        <div class="bubble ai-bubble">${text}</div>
                        <div class="meta-container">
                            <span class="text-[8px] mono opacity-40 uppercase tracking-widest">NODE_VERIFIED_MEMORY</span>
                        </div>
                    `;
                }, 1000);
            } catch (e) { card.innerHTML = "Neural sync failed."; }
        };

        window.manualAdd = (trigger) => {
            appendMessage(`Training new branch for: "${trigger}"`, true, { isNew: true, trigger });
        };

        function appendMessage(text, isAi = false, metadata = null) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${isAi ? 'ai-message' : 'user-message'}`;
            
            let html = ``;
            if (isAi) {
                if (metadata?.isNew) {
                    const tid = Math.random().toString(36).substring(7);
                    html = `<div class="training-card" id="card-${tid}">
                        <textarea id="teach-in-${tid}" spellcheck="true" placeholder="Enter community response..." class="w-full bg-white/5 border border-white/20 rounded-2xl p-5 text-xs mono mb-3 outline-none h-32 resize-none focus:border-white/50"></textarea>
                        <p id="err-${tid}" class="text-[10px] text-red-500 mb-4 mono px-1"></p>
                        <button onclick="window.submitTraining('${metadata.trigger.replace(/'/g, "\\'")}', '${tid}')" class="w-full py-4 bg-white text-black rounded-xl text-[12px] font-black uppercase tracking-widest hover:bg-neutral-200 transition-all">Store in Hive</button>
                    </div>`;
                } else {
                    const likes = metadata?.likes || 0;
                    const dislikes = metadata?.dislikes || 0;
                    const docId = metadata?.id;
                    const conf = metadata?.score ? `<span class="confidence-label ml-auto text-[8px] mono opacity-30">CONF: ${Math.round(metadata.score * 100)}%</span>` : '';
                    
                    html = `
                        <div class="flex items-start">
                            <div class="bubble ai-bubble">${text}</div>
                            <div class="train-plus" onclick="window.manualAdd('${text.replace(/'/g, "\\'")}')" title="Teach Alternative">+</div>
                        </div>
                        <div class="meta-container">
                            <button onclick="window.vote('${docId}', 'up', this)" class="meta-btn">Accept [${likes}]</button>
                            <button onclick="window.vote('${docId}', 'down', this)" class="meta-btn">Deny [${dislikes}]</button>
                            <button onclick="window.vote('${docId}', 'report', this)" class="meta-btn" style="color:#ef4444">Report</button>
                            ${conf}
                        </div>`;
                }
            } else {
                html = `<div class="bubble user-bubble">${text}</div>`;
            }

            msgDiv.innerHTML = html;
            chatWindow.appendChild(msgDiv);
            chatWindow.scrollTo(0, chatWindow.scrollHeight);
        }

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = userInput.value.trim();
            if (!text) return;
            userInput.value = '';
            appendMessage(text, false);
            
            logo.classList.add('spinning');
            
            setTimeout(async () => {
                logo.classList.remove('spinning');
                
                const queryWords = text.toLowerCase().trim().split(/\s+/).filter(w => w.length > 2);
                let bestMatch = null;
                let highestScore = 0;

                hiveMemory.forEach(item => {
                    const target = item.input_text.toLowerCase();
                    if (target === text.toLowerCase().trim()) { highestScore = 1.1; bestMatch = item; return; }
                    
                    const targetWords = target.split(/\s+/);
                    const overlap = queryWords.filter(w => targetWords.includes(w)).length;
                    const score = overlap / Math.max(queryWords.length, targetWords.length);
                    if (score > highestScore) { highestScore = score; bestMatch = item; }
                });

                if (bestMatch && highestScore > 0.4) {
                    appendMessage(bestMatch.response_text, true, { 
                        id: bestMatch.id, 
                        likes: bestMatch.likes, 
                        dislikes: bestMatch.dislikes, 
                        score: Math.min(highestScore, 1) 
                    });
                } else if (document.getElementById('search-permission').checked) {
                    try {
                        const r = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(text.replace(/\s+/g, '_'))}`);
                        const d = await r.json();
                        if (d.extract) appendMessage(d.extract, true);
                        else appendMessage(`Query not found in memory archives.`, true, { isNew: true, trigger: text });
                    } catch { appendMessage(`Query not found in memory archives.`, true, { isNew: true, trigger: text }); }
                } else {
                    appendMessage(`Query not found in memory archives.`, true, { isNew: true, trigger: text });
                }
            }, 1000);
        });

        init();
    </script>
</body>
</html>
